<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAILY - Project Initialization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .project-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2em;
        }
        .project-detail-header h1 {
            margin: 0;
            font-size: 2em;
            color: var(--header-color);
            display: flex;
            align-items: center;
        }
        .project-state-tag {
            background-color: var(--highlight-color); /* 예시 색상 */
            color: var(--primary-color); /* 예시 색상 */
            padding: 0.3em 0.7em;
            border-radius: 5px;
            font-size: 0.7em;
            margin-left: 1em;
            font-weight: bold;
        }
        .project-info-card {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 2em;
        }
        .project-info-card h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.5em;
            margin-bottom: 1em;
        }
        .project-info-card p {
            margin-bottom: 0.8em;
        }
        .project-info-card .info-item {
            margin-bottom: 1em;
        }
        .project-info-card .info-item strong {
            display: inline-block;
            width: 120px; /* Adjust as needed */
            vertical-align: top;
        }
        .project-info-card .info-item span,
        .project-info-card .info-item textarea.form-control {
            display: inline-block;
            vertical-align: top;
            width: calc(100% - 130px); /* Adjust based on strong width */
        }
        textarea.form-control {
            width: 100%;
            padding: 0.8em;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9em;
            resize: vertical;
        }
        .action-buttons button {
            margin-left: 1em;
        }
        .file-list-section {
            background-color: var(--card-bg-color);
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .file-list-section h2 {
            margin-top: 0;
            color: var(--header-color);
            font-size: 1.5em;
            margin-bottom: 1em;
        }
        .file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .file-list li {
            display: flex;
            align-items: center;
            padding: 0.8em 0;
            border-bottom: 1px solid var(--border-color);
        }
        .file-list li:last-child {
            border-bottom: none;
        }
        .file-list .file-name {
            flex-grow: 1;
            color: var(--text-color);
        }
        .file-list .file-extension-tag {
            background-color: var(--highlight-color);
            color: var(--primary-color);
            padding: 0.3em 0.7em;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 0.5em;
        }
        .file-list .select-file-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5em 1em;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-left: 1em;
        }
        .file-list .select-file-btn:hover {
            background-color: #6B9E12;
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            /* display: flex; */ /* 초기 로드 시 모달이 보이지 않도록 제거 */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg-color);
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more specific */
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #progress-log {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-top: 1em;
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }

        .progress-container {
            width: 100%;
            background-color: var(--input-bg-color);
            border-radius: 5px;
            margin-bottom: 1em;
            overflow: hidden; /* Ensure progress-bar doesn't overflow */
        }

        .progress-bar {
            width: 0%;
            height: 25px;
            background-color: var(--primary-color);
            text-align: center;
            line-height: 25px;
            color: white;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
            font-weight: bold;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflowing text */
            text-overflow: ellipsis; /* Add ellipsis for overflowing text */
        }

        #file-list-modal {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-top: 1em;
            background-color: var(--input-bg-color);
        }

        #file-list-modal li {
            margin-bottom: 0.5em;
        }

        /* File tree styles */
        .nested {
            list-style: none;
            padding-left: 1em;
            display: none; /* Hidden by default */
        }

        .file-tree-item {
            margin-bottom: 0.3em;
        }

        .file-tree-item input[type="checkbox"] {
            margin-right: 0.5em;
        }

        .file-tree-folder-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.3em; /* 폴더 헤더와 하위 항목 간 간격 */
        }

        .file-tree-file-item {
            display: flex; /* 체크박스와 파일 이름 정렬 */
            align-items: center;
        }

        .file-tree-folder > .nested {
            padding-left: 1.5em; /* 폴더 하위 항목 들여쓰기 */
        }

        .nested.active {
            display: block;
        }

        .folder-toggle {
            cursor: pointer;
            margin-right: 0.5em;
        }

        .folder-name {
            font-weight: bold;
        }

        .file-item {
            margin-left: 1.5em; /* Indent files */
        }
    </style>
</head>
<body>
    {% include 'nav/navbar.html' %}

    <div class="container">
        {% include 'nav/sidebar.html' %}
        <div class="main-content">
            <div class="project-detail-header">
                <h1>Project: {{ project.name }} <span class="project-state-tag">{{ project.state }}</span></h1>
                <div class="action-buttons">
                    {% if project.state == 'new' %}
                        <button class="btn" id="init_project_btn">Initialize Project</button>
                        <button class="btn btn-danger" id="delete_project_btn">Delete Project</button>
                    {% elif project.state == 'initialized' %}
                        <button class="btn">Start Analysis</button>
                        <button class="btn btn-danger" id="delete_project_btn">Delete Project</button>
                    {% elif project.state == 'deleted' %}
                        <button class="btn" disabled>Initialize Project</button>
                        <button class="btn btn-danger" disabled>Delete Project</button>
                    {% endif %}
                </div>
            </div>

            <div class="project-info-card">
                <div class="info-item">
                    <strong>Root Directory:</strong> <span>{{ project.root_dir }}</span>
                </div>
                <div class="info-item">
                    <strong>Interface Script:</strong>
                    <textarea id="if_script_textarea" class="form-control" rows="20">{{ project.if_script }}</textarea>
                </div>
            </div>

            {% if project.state == 'initialized' %}
            <div class="file-list-section">
                <h2>Project Files</h2>
                <ul class="file-list">
                    {% for file in files %}
                    <li>
                        <span class="file-name">{{ file.name }}</span>
                        <span class="file-extension-tag">{{ file.extension }}</span>
                        <button class="select-file-btn">Select</button>
                    </li>
                    {% else %}
                    <li>No files found in the project directory.</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <div id="initModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="initModalCloseButton">&times;</span>
            <h2>Project Initialization Progress</h2>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div id="progress-log"></div>
        </div>
    </div>

    <div id="fileSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="fileSelectionCloseButton">&times;</span>
            <h2>Select Files to Analyze</h2>
            <div id="file-selection-area">
                <ul id="file-list-modal"></ul>
                <button class="btn" id="save_selected_files_btn">Save Selected Files</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const initProjectBtn = document.getElementById('init_project_btn');
            const deleteProjectBtn = document.getElementById('delete_project_btn');
            const projectId = "{{ project.id | tojson }}"; // project.id는 정수이므로 문자열로 변환
            const projectState = "{{ project.state }}"; // project.state는 이미 문자열이므로 그대로 사용

            const initModal = document.getElementById('initModal');
            const initModalCloseButton = document.getElementById('initModalCloseButton');
            const progressLog = document.getElementById('progress-log');
            
            const fileSelectionModal = document.getElementById('fileSelectionModal');
            const fileSelectionCloseButton = document.getElementById('fileSelectionCloseButton');
            const fileListModal = document.getElementById('file-list-modal');
            const saveSelectedFilesBtn = document.getElementById('save_selected_files_btn'); // 버튼 ID 변경

            let currentStep = 0;
            const steps = [
                "Workspace 초기화 중...",
                "Interface 설치 중...",
                "Project Init 중...",
                "Project Build 중...",
                "Project Run 중...",
                "프로젝트 하위 파일 검색 중..."
            ];

            function showInitModal() {
                initModal.style.display = 'flex';
                progressLog.innerHTML = '';
                currentStep = 0;
            }

            function hideInitModal() {
                initModal.style.display = 'none';
            }

            function showFileSelectionModal() {
                fileSelectionModal.style.display = 'flex';
            }

            function hideFileSelectionModal() {
                fileSelectionModal.style.display = 'none';
            }

            initModalCloseButton.addEventListener('click', hideInitModal);
            fileSelectionCloseButton.addEventListener('click', hideFileSelectionModal);

            window.addEventListener('click', function(event) {
                if (event.target == initModal) {
                    hideInitModal();
                }
                if (event.target == fileSelectionModal) {
                    hideFileSelectionModal();
                }
            });

            async function runInitializationStep(step) {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = Math.round(((step + 1) / steps.length) * 100);
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${progressPercentage}% - ${steps[step]}`;

                try {
                    const response = await fetch(`/project/init/step`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ project_id: projectId, step: step })
                    });
                    const data = await response.json();

                    progressLog.innerHTML += `<p>${data.msg}</p>`;

                    if (data.success) {
                        if (data.next_step !== undefined) {
                            currentStep = data.next_step;
                            if (currentStep < steps.length) {
                                setTimeout(() => runInitializationStep(currentStep), 1000);
                            } else {
                                progressBar.style.width = '100%';
                                progressBar.textContent = '100% - 프로젝트 초기화 완료!';
                                if (data.files) {
                                    hideInitModal(); // 초기화 모달 숨기기
                                    displayFilesForSelection(data.files); // 파일 선택 모달 표시
                                } else if (data.redirect_url) {
                                    setTimeout(() => window.location.href = data.redirect_url, 1000);
                                } else {
                                    alert('프로젝트 초기화 완료!');
                                    hideInitModal();
                                    setTimeout(() => window.location.reload(), 1000);
                                }
                            }
                        } else if (data.redirect_url) {
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100% - 프로젝트 초기화 완료!';
                            setTimeout(() => window.location.href = data.redirect_url, 1000);
                        } else {
                            alert('프로젝트 초기화 완료!');
                            hideInitModal();
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } else {
                        alert('초기화 실패: ' + data.msg);
                        hideInitModal();
                    }
                } catch (error) {
                    console.error('Error during initialization step:', error);
                    progressLog.innerHTML += `<p style="color: red;">오류 발생: ${error.message}</p>`;
                    alert('프로젝트 초기화 중 예상치 못한 오류가 발생했습니다.');
                    hideInitModal();
                }
            }

            function buildFileTree(files) {
                const tree = {};
                files.forEach(file => {
                    const parts = file.split(/[\\/]/);
                    let currentLevel = tree;
                    parts.forEach((part, index) => {
                        if (index === parts.length - 1) { // 마지막 부분은 파일 또는 빈 폴더
                            if (file.indexOf('.') !== -1) { // 파일인 경우
                                currentLevel[part] = file; // 파일 경로 문자열 저장
                            } else { // 마지막 부분인데 확장자가 없으면 폴더로 간주
                                if (!currentLevel[part]) { // 이미 존재하지 않으면 빈 객체로 초기화
                                    currentLevel[part] = {};
                                }
                            }
                        } else { // 중간 폴더
                            if (typeof currentLevel[part] === 'string') { // 이미 파일로 저장되어 있으면 객체로 변경
                                currentLevel[part] = {};
                            }
                            if (!currentLevel[part]) { // 존재하지 않으면 빈 객체로 초기화
                                currentLevel[part] = {};
                            }
                            currentLevel = currentLevel[part];
                        }
                    });
                });
                return tree;
            }

            function renderFileTree(node, parentUl) {
                for (const key in node) {
                    const value = node[key];
                    const li = document.createElement('li');

                    if (typeof value === 'string') { // 파일인 경우
                        li.className = 'file-tree-item file-tree-file-item'; // 파일에 대한 클래스 추가
                        li.innerHTML = `<input type="checkbox" value="${value}"> ${key}`;
                        parentUl.appendChild(li); // 파일을 부모 ul에 직접 추가
                    } else { // 폴더인 경우
                        li.className = 'file-tree-item file-tree-folder'; // 폴더에 대한 클래스 추가
                        
                        const folderHeader = document.createElement('div');
                        folderHeader.className = 'file-tree-folder-header';

                        const folderCheckbox = document.createElement('input');
                        folderCheckbox.type = 'checkbox';
                        folderCheckbox.dataset.folderName = key; // 데이터 속성으로 폴더 이름 저장
                        folderHeader.appendChild(folderCheckbox);

                        const folderToggle = document.createElement('span');
                        folderToggle.className = 'folder-toggle';
                        folderHeader.appendChild(folderToggle);

                        const folderName = document.createElement('span');
                        folderName.className = 'folder-name';
                        folderName.textContent = key;
                        folderHeader.appendChild(folderName);

                        li.appendChild(folderHeader);

                        const nestedUl = document.createElement('ul');
                        nestedUl.className = 'nested';
                        li.appendChild(nestedUl);

                        folderToggle.addEventListener('click', function() {
                            this.classList.toggle('folder-toggle-down');
                            nestedUl.classList.toggle('active');
                        });

                        folderCheckbox.addEventListener('change', function() {
                            const isChecked = this.checked;
                            // 하위의 모든 체크박스 (파일 및 폴더) 선택/해제
                            nestedUl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                                checkbox.checked = isChecked;
                            });
                        });

                        renderFileTree(value, nestedUl); // 하위 항목을 nestedUl에 렌더링
                        parentUl.appendChild(li); // 폴더를 부모 ul에 직접 추가
                    }
                }
            }

            function displayFilesForSelection(files) {
                fileListModal.innerHTML = '';
                const fileTree = buildFileTree(files);
                renderFileTree(fileTree, fileListModal);
                showFileSelectionModal(); // 파일 선택 모달 표시
            }

            saveSelectedFilesBtn.addEventListener('click', async function() { // 버튼 ID 변경
                const selectedFiles = Array.from(fileListModal.querySelectorAll('input[type="checkbox"]:checked'))
                                            .map(checkbox => checkbox.value)
                                            .filter(value => value.indexOf('.') !== -1); // 파일만 선택

                if (selectedFiles.length === 0) {
                    alert('분석할 파일을 하나 이상 선택해주세요.');
                    return;
                }

                hideFileSelectionModal(); // 파일 선택 모달 숨기기
                showInitModal(); // 초기화 모달 다시 표시 (진행 상황 로그를 위해)

                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = `100% - ${steps[steps.length - 1]} 완료!`; // 마지막 스텝 메시지 사용

                try {
                    const response = await fetch(`/project/init/step`, { // Step 7 API call
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ project_id: projectId, step: 6, selected_files: selectedFiles })
                    });
                    const data = await response.json();

                    progressLog.innerHTML += `<p>${data.msg}</p>`;

                    if (data.success) {
                        alert('파일 전송 및 초기화 완료!');
                        hideInitModal();
                        window.location.reload();
                    } else {
                        alert('파일 전송 실패: ' + data.msg);
                        hideInitModal();
                    }
                } catch (error) {
                    console.error('Error sending selected files:', error);
                    progressLog.innerHTML += `<p style="color: red;">오류 발생: ${error.message}</p>`;
                    alert('파일 전송 중 예상치 못한 오류가 발생했습니다.');
                    hideInitModal();
                }
            });


            if (initProjectBtn) {
                initProjectBtn.addEventListener('click', async function() {
                    const ifScriptContent = document.getElementById('if_script_textarea').value;

                    if (confirm('프로젝트를 초기화하시겠습니까? 이 작업은 인터페이스 스크립트를 저장하고 프로젝트 디렉토리를 생성하며 스크립트를 실행합니다.')) {
                        showInitModal(); // Initialize 버튼 클릭 시 초기화 모달 띄우기

                        try {
                            // 1. if_script 업데이트
                            const progressBar = document.getElementById('progressBar');
                            progressBar.style.width = '0%';
                            progressBar.textContent = '0% - 인터페이스 스크립트 저장 중...';
                            progressLog.innerHTML += `<p><strong>인터페이스 스크립트 저장 중...</strong></p>`;
                            const updateResponse = await fetch(`/project/update/${projectId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ if_script: ifScriptContent })
                            });
                            const updateData = await updateResponse.json();

                            progressLog.innerHTML += `<p>${updateData.msg}</p>`;

                            if (!updateData.success) {
                                alert('인터페이스 스크립트 저장 실패: ' + updateData.msg);
                                hideInitModal();
                                return;
                            }
                            
                            // Start step-by-step initialization
                            runInitializationStep(currentStep);

                        } catch (error) {
                            console.error('Error during project initialization setup:', error);
                            alert('프로젝트 초기화 설정 중 예상치 못한 오류가 발생했습니다.');
                            hideInitModal();
                        }
                    }
                });
            }

            if (deleteProjectBtn) {
                deleteProjectBtn.addEventListener('click', function() {
                    if (confirm('프로젝트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                        fetch(`/project/delete/${projectId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.msg);
                                window.location.reload();
                            } else {
                                alert('삭제 실패: ' + data.msg);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting project:', error);
                            alert('프로젝트 삭제 중 예상치 못한 오류가 발생했습니다.');
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>

            let currentStep = 0;
            const steps = [
                "Workspace 초기화 중...",
                "Interface 설치 중...",
                "Project Init 중...",
                "Project Build 중...",
                "Project Run 중...",
                "프로젝트 하위 파일 검색 중...",
            ];

            function showModal() {
                initModal.style.display = 'flex'; // 모달을 flex 컨테이너로 설정하여 중앙 정렬
                progressLog.innerHTML = ''; // Clear previous logs
                fileSelectionArea.style.display = 'none'; // Hide file selection initially
                currentStep = 0;
            }

            function hideModal() {
                initModal.style.display = 'none';
            }

            closeButton.addEventListener('click', hideModal);
            window.addEventListener('click', function(event) {
                if (event.target == initModal) {
                    hideModal();
                }
            });

            async function runInitializationStep(step) {
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = Math.round(((step + 1) / steps.length) * 100);
                progressBar.style.width = `${progressPercentage}%`;
                progressBar.textContent = `${progressPercentage}% - ${steps[step]}`;

                try {
                    const response = await fetch(`/project/init/step`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ project_id: projectId, step: step })
                    });
                    const data = await response.json();

                    progressLog.innerHTML += `<p>${data.msg}</p>`; // msg는 기존처럼 쭉 표현

                    if (data.success) {
                        if (data.next_step !== undefined) {
                            currentStep = data.next_step;
                            if (currentStep < steps.length) {
                                setTimeout(() => runInitializationStep(currentStep), 1000); // 1초 딜레이 추가
                            } else {
                                // All steps completed, handle final redirect or file selection
                                progressBar.style.width = '100%';
                                progressBar.textContent = '100% - 프로젝트 초기화 완료!';
                                if (data.files) { // Step 6 returns files
                                    displayFilesForSelection(data.files);
                                } else if (data.redirect_url) {
                                    setTimeout(() => window.location.href = data.redirect_url, 1000); // 1초 딜레이 추가
                                } else {
                                    alert('프로젝트 초기화 완료!');
                                    hideModal();
                                    setTimeout(() => window.location.reload(), 1000); // 1초 딜레이 추가
                                }
                            }
                        } else if (data.redirect_url) {
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100% - 프로젝트 초기화 완료!';
                            setTimeout(() => window.location.href = data.redirect_url, 1000); // 1초 딜레이 추가
                        } else {
                            alert('프로젝트 초기화 완료!');
                            hideModal();
                            setTimeout(() => window.location.reload(), 1000); // 1초 딜레이 추가
                        }
                    } else {
                        alert('초기화 실패: ' + data.msg);
                        hideModal();
                    }
                } catch (error) {
                    console.error('Error during initialization step:', error);
                    progressLog.innerHTML += `<p style="color: red;">오류 발생: ${error.message}</p>`;
                    alert('프로젝트 초기화 중 예상치 못한 오류가 발생했습니다.');
                    hideModal();
                }
            }

            function buildFileTree(files) {
                const tree = {};
                files.forEach(file => {
                    const parts = file.split(/[\\/]/); // Windows/Linux 경로 모두 처리
                    let currentLevel = tree;
                    parts.forEach((part, index) => {
                        if (!currentLevel[part]) {
                            currentLevel[part] = {};
                        }
                        if (index === parts.length - 1 && file.indexOf('.') !== -1) { // 파일인 경우
                            currentLevel[part] = file; // 파일 경로 자체를 저장
                        }
                        currentLevel = currentLevel[part];
                    });
                });
                return tree;
            }

            function renderFileTree(node, parentUl) {
                for (const key in node) {
                    const value = node[key];
                    const li = document.createElement('li');

                    if (typeof value === 'string') { // 파일인 경우
                        li.className = 'file-item';
                        li.innerHTML = `<input type="checkbox" value="${value}"> ${key}`;
                    } else { // 폴더인 경우
                        const folderToggle = document.createElement('span');
                        folderToggle.className = 'folder-toggle';
                        li.appendChild(folderToggle);

                        const folderName = document.createElement('span');
                        folderName.className = 'folder-name';
                        folderName.textContent = key;
                        li.appendChild(folderName);

                        const nestedUl = document.createElement('ul');
                        nestedUl.className = 'nested';
                        li.appendChild(nestedUl);

                        folderToggle.addEventListener('click', function() {
                            this.classList.toggle('folder-toggle-down');
                            nestedUl.classList.toggle('active');
                        });
                        renderFileTree(value, nestedUl);
                    }
                    parentUl.appendChild(li);
                }
            }

            function displayFilesForSelection(files) {
                fileListModal.innerHTML = '';
                const fileTree = buildFileTree(files);
                renderFileTree(fileTree, fileListModal);
                fileSelectionArea.style.display = 'block';
            }

            sendSelectedFilesBtn.addEventListener('click', async function() {
                const selectedFiles = Array.from(fileListModal.querySelectorAll('input[type="checkbox"]:checked'))
                                            .map(checkbox => checkbox.value);
                
                if (selectedFiles.length === 0) {
                    alert('분석할 파일을 하나 이상 선택해주세요.');
                    return;
                }

                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = '100%';
                progressBar.textContent = '100% - 선택된 파일 서버로 전송 중...';

                try {
                    const response = await fetch(`/project/init/step`, { // Step 7 API call
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ project_id: projectId, step: 6, selected_files: selectedFiles })
                    });
                    const data = await response.json();

                    progressLog.innerHTML += `<p>${data.msg}</p>`;

                    if (data.success) {
                        alert('파일 전송 및 초기화 완료!');
                        hideModal();
                        window.location.reload();
                    } else {
                        alert('파일 전송 실패: ' + data.msg);
                        hideModal();
                    }
                } catch (error) {
                    console.error('Error sending selected files:', error);
                    progressLog.innerHTML += `<p style="color: red;">오류 발생: ${error.message}</p>`;
                    alert('파일 전송 중 예상치 못한 오류가 발생했습니다.');
                    hideModal();
                }
            });


            if (initProjectBtn) {
                initProjectBtn.addEventListener('click', async function() {
                    const ifScriptContent = document.getElementById('if_script_textarea').value;

                    if (confirm('프로젝트를 초기화하시겠습니까? 이 작업은 인터페이스 스크립트를 저장하고 프로젝트 디렉토리를 생성하며 스크립트를 실행합니다.')) {
                        showModal(); // Initialize 버튼 클릭 시 모달 띄우기

                        try {
                            // 1. if_script 업데이트
                            const progressBar = document.getElementById('progressBar');
                            progressBar.style.width = '0%';
                            progressBar.textContent = '0% - 인터페이스 스크립트 저장 중...';
                            progressLog.innerHTML += `<p><strong>인터페이스 스크립트 저장 중...</strong></p>`;
                            const updateResponse = await fetch(`/project/update/${projectId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ if_script: ifScriptContent })
                            });
                            const updateData = await updateResponse.json();

                            progressLog.innerHTML += `<p>${updateData.msg}</p>`;

                            if (!updateData.success) {
                                alert('인터페이스 스크립트 저장 실패: ' + updateData.msg);
                                hideModal();
                                return;
                            }
                            
                            // Start step-by-step initialization
                            runInitializationStep(currentStep);

                        } catch (error) {
                            console.error('Error during project initialization setup:', error);
                            alert('프로젝트 초기화 설정 중 예상치 못한 오류가 발생했습니다.');
                            hideModal();
                        }
                    }
                });
            }

            // deleteProjectBtn 관련 로직은 이미 존재하므로 추가하지 않습니다.
            // if (deleteProjectBtn) {
            //     deleteProjectBtn.addEventListener('click', function() {
            //         if (confirm('프로젝트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
            //             fetch(`/project/delete/${projectId}`, {
            //                 method: 'POST',
            //                 headers: {
            //                     'Content-Type': 'application/json'
            //                 }
            //             })
            //             .then(response => response.json())
            //             .then(data => {
            //                 if (data.success) {
            //                     alert(data.msg);
            //                     window.location.reload(); // 페이지 새로고침하여 상태 반영
            //                 } else {
            //                     alert('삭제 실패: ' + data.msg);
            //                 }
            //             })
            //             .catch(error => {
            //                 console.error('Error deleting project:', error);
            //                 alert('프로젝트 삭제 중 예상치 못한 오류가 발생했습니다.');
            //             });
            //         }
            //     });
            // }

            if (deleteProjectBtn) {
                deleteProjectBtn.addEventListener('click', function() {
                    if (confirm('프로젝트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                        fetch(`/project/delete/${projectId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.msg);
                                window.location.reload(); // 페이지 새로고침하여 상태 반영
                            } else {
                                alert('삭제 실패: ' + data.msg);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting project:', error);
                            alert('프로젝트 삭제 중 예상치 못한 오류가 발생했습니다.');
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>
