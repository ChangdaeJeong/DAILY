<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAILY - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/loading.js') }}"></script>
</head>
<body>
    {% include 'util/loading.html' %}
    {% include 'nav/navbar.html' %}

    <div class="container">
        {% include 'nav/sidebar.html' with context %}
        <div class="main-content">
            <div class="main-header">
                <!-- Say hello user name, user data from current app -->
                <h1>Welcome to Your Dashboard</h1>
                <button onclick="window.location.href='{{ url_for('main.project.create') }}'" class="btn">+ Create New Project</button>
            </div>
            <div class="feed-section">
                <h2>Recent Activities</h2>
                <div id="activities-list">
                    <!-- Activities will be loaded here by JavaScript -->
                </div>
                <button id="load-more-activities" class="btn btn-secondary" style="display: none;">Load More</button>
            </div>
        </div>
    </div>

    <script>
        let offset = 0;
        const limit = 7;
        const activitiesList = document.getElementById('activities-list');
        const loadMoreButton = document.getElementById('load-more-activities');

        async function fetchActivities() {
            try {
                const response = await fetch(`/message/get_recent_activities?limit=${limit}&offset=${offset}`);
                const messages = await response.json();

                if (messages.length > 0) {
                    messages.forEach(msg => {
                        const feedItem = document.createElement('div');
                        feedItem.classList.add('feed-item');
                        feedItem.innerHTML = `
                            <h3>${msg.title}</h3>
                            <p>${msg.message}</p>
                            <span class="timestamp">${msg.created_at}</span>
                        `;
                        activitiesList.appendChild(feedItem);
                    });
                    offset += messages.length;
                    if (messages.length === limit) {
                        loadMoreButton.style.display = 'block';
                    } else {
                        loadMoreButton.style.display = 'none';
                    }
                } else {
                    loadMoreButton.style.display = 'none';
                    if (offset === 0) { // No activities at all
                        activitiesList.innerHTML = '<p>No recent activities.</p>';
                    }
                }
            } catch (error) {
                console.error('Error fetching recent activities:', error);
                if (offset === 0) {
                    activitiesList.innerHTML = '<p>Failed to load recent activities.</p>';
                }
                loadMoreButton.style.display = 'none';
            }
        }

        loadMoreButton.addEventListener('click', fetchActivities);

        // Initial load
        document.addEventListener('DOMContentLoaded', fetchActivities);
    </script>
</body>
</html>
